
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOW-Agent - Interactive Dialog</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/index.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --accent: #00B8D4;
            --dark: #1A1A1A;
            --dark-lighter: #2D2D2D;
            --white: #FFFFFF;
            --gray: rgba(255, 255, 255, 0.7);
            --border-radius: 12px;
        }
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark);
            color: var(--white);
            overflow: hidden;
            height: 100vh;
        }

        #welcomeScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-lighter) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 40px 20px; z-index: 1000;
        }
        #welcomeScreen.hidden { display: none; }
        #welcomeScreen h1 { font-size: 48px; font-weight: 900; margin-bottom: 10px; }
        #welcomeScreen h1 .accent { color: var(--accent); }
        #welcomeScreen p { font-size: 18px; color: var(--gray); max-width: 500px; margin-bottom: 40px; }
        #startBtn {
            background: var(--accent); color: var(--dark); padding: 18px 50px;
            border: none; border-radius: var(--border-radius); font-size: 18px; font-weight: 700;
            cursor: pointer;
        }
        #startBtn:hover { background: #00A3C0; }
        #startBtn:disabled { opacity: 0.5; }

        #loadingScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1001;
        }
        #loadingScreen.hidden { display: none; }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 30px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #chatScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column; z-index: 1002;
        }
        #chatScreen.hidden { display: none; }

        #videoContainer {
            flex: 1; position: relative; background: #000;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #videoContainer video { width: 100%; height: 100%; object-fit: cover; }

        .chat-header {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }

        #statusBadge {
            background: rgba(0, 0, 0, 0.8); padding: 12px 20px;
            border-radius: var(--border-radius); font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #888; }
        #statusBadge.listening .status-dot { background: #00FF00; animation: pulse-dot 1.5s infinite; }
        #statusBadge.speaking .status-dot { background: #FF0000; animation: pulse-dot 1.5s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        #timer {
            background: rgba(0, 0, 0, 0.8); padding: 12px 20px;
            border-radius: var(--border-radius); color: var(--accent); font-family: monospace;
        }

        #closeBtn {
            background: rgba(0, 0, 0, 0.8); border: none; color: var(--white);
            width: 44px; height: 44px; border-radius: 50%; font-size: 24px; cursor: pointer;
        }
        #closeBtn:hover { background: rgba(255, 0, 0, 0.5); }

        /* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.95); padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1); z-index: 5;
            display: flex; gap: 10px; align-items: flex-end;
        }

        /* –ß–ê–¢ –°–õ–ï–í–ê */
        .chat-wrapper {
            flex: 1; max-width: 450px;
        }
        #chatInput {
            width: 100%; padding: 12px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
            color: white; font-size: 14px;
        }
        #chatInput:focus { outline: none; border-color: var(--accent); }
        #chatInput:disabled { opacity: 0.5; cursor: not-allowed; }
        #sendMessageBtn {
            width: 100%; padding: 10px; margin-top: 8px;
            background: var(--accent); color: var(--dark); border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer;
        }
        #sendMessageBtn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* –ò–°–¢–û–†–ò–Ø –°–ü–†–ê–í–ê */
        #transcript {
            flex: 1; max-width: 350px; height: 150px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--accent);
            border-radius: 8px; padding: 10px; overflow-y: auto; font-size: 11px;
        }
        #transcript h4 { color: var(--accent); margin-bottom: 8px; font-size: 12px; border-bottom: 1px solid var(--accent); padding-bottom: 5px; }
        .transcript-msg { margin-bottom: 8px; padding: 6px; border-radius: 4px; }
        .transcript-msg.user { background: rgba(0,184,212,0.15); color: #00B8D4; }
        .transcript-msg.avatar { background: rgba(255,107,107,0.15); color: #FF6B6B; }
        .transcript-time { font-size: 9px; color: #666; margin-top: 2px; }

        #thankYouScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--dark) 0%, var(--dark-lighter) 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 1003; padding: 40px 20px;
        }
        #thankYouScreen.hidden { display: none; }

        .thank-you-card {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 40px; max-width: 600px; text-align: center;
        }
        .thank-you-card input {
            width: 100%; padding: 15px; margin-bottom: 10px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: white;
        }
        .thank-you-card button {
            width: 100%; padding: 15px; margin-top: 10px;
            border-radius: 8px; border: none; font-weight: bold; cursor: pointer;
        }
        .btn-primary { background: var(--accent); color: var(--dark); }
        .btn-outline { background: transparent; border: 2px solid var(--accent) !important; color: var(--accent); }
        .btn-secondary { background: rgba(0,184,212,0.2); color: var(--accent); margin-top: 8px; }

        .transcript-box {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 15px; margin: 20px 0; text-align: left; max-height: 300px;
            overflow-y: auto; font-size: 13px;
        }
        .transcript-box h3 { color: var(--accent); margin-bottom: 10px; }
        .tr-item { margin-bottom: 8px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; }
        .tr-item strong { color: var(--accent); }
    </style>
</head>
<body>

    <div id="welcomeScreen">
        <h1>–í–ê–® –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô<br><span class="accent">WOW-–ê–ì–ï–ù–¢</span></h1>
        <p>–ì–æ–ª–æ—Å + –ß–∞—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ + –ò—Å—Ç–æ—Ä–∏—è</p>
        <button id="startBtn">üé§ –ù–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä</button>
        <small style="margin-top: 20px; color: #666;">–ü–∏—à–∏—Ç–µ –ò –≥–æ–≤–æ—Ä–∏—Ç–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</small>
    </div>

    <div id="loadingScreen" class="hidden">
        <div class="spinner"></div>
        <p id="loadingText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
    </div>

    <div id="chatScreen" class="hidden">
        <div id="videoContainer"></div>

        <div class="chat-header">
            <div id="statusBadge">
                <span class="status-dot"></span>
                <span id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
            </div>
            <div id="timer">00:00</div>
            <button id="closeBtn">‚úï</button>
        </div>

        <div class="bottom-panel">
            <div class="chat-wrapper">
                <input id="chatInput" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button id="sendMessageBtn" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>

            <div id="transcript">
                <h4>üìù –ò—Å—Ç–æ—Ä–∏—è</h4>
                <div id="transcriptList"></div>
            </div>
        </div>
    </div>

    <div id="thankYouScreen" class="hidden">
        <div class="thank-you-card">
            <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä! üéâ</h2>
            <p>–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.</p>

            <!-- –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê -->
            <div class="transcript-box">
                <h3>üìù –ü–æ–ª–Ω–∞—è –ò—Å—Ç–æ—Ä–∏—è –î–∏–∞–ª–æ–≥–∞</h3>
                <div id="finalTranscript"></div>
            </div>

            <form id="leadForm">
                <input type="text" placeholder="–í–∞—à–µ –∏–º—è">
                <input type="email" placeholder="Email">
                <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </form>

            <button id="downloadTranscript" class="btn-secondary">üì• –°–∫–∞—á–∞—Ç—å –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—é (JSON)</button>
            <button id="copyTranscript" class="btn-secondary">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¢–µ–∫—Å—Ç</button>
            <button id="reloadBtn" class="btn-outline">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>

    <script>
        let state = {
            sessionId: null,
            sessionToken: null,
            room: null,
            localMicTrack: null,
            videoEl: null,
            audioEl: null,
            countdown: null,
            secondsLeft: 0,
            transcripts: []
        };

        const ui = {
            screens: {
                welcome: document.getElementById('welcomeScreen'),
                loading: document.getElementById('loadingScreen'),
                chat: document.getElementById('chatScreen'),
                thankYou: document.getElementById('thankYouScreen')
            },
            startBtn: document.getElementById('startBtn'),
            closeBtn: document.getElementById('closeBtn'),
            reloadBtn: document.getElementById('reloadBtn'),
            statusBadge: document.getElementById('statusBadge'),
            statusText: document.getElementById('statusText'),
            timer: document.getElementById('timer'),
            videoContainer: document.getElementById('videoContainer'),
            loadingText: document.getElementById('loadingText'),
            chatInput: document.getElementById('chatInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            transcript: document.getElementById('transcript'),
            transcriptList: document.getElementById('transcriptList'),
            finalTranscript: document.getElementById('finalTranscript'),
            leadForm: document.getElementById('leadForm'),
            downloadBtn: document.getElementById('downloadTranscript'),
            copyBtn: document.getElementById('copyTranscript')
        };

        function showScreen(name) {
            Object.values(ui.screens).forEach(el => el.classList.add('hidden'));
            ui.screens[name].classList.remove('hidden');
        }

        function updateStatus(status) {
            if (status === 'speaking') {
                ui.statusBadge.className = 'speaking';
                ui.statusText.textContent = 'üî¥ –ê–≤–∞—Ç–∞—Ä –≥–æ–≤–æ—Ä–∏—Ç';
            } else if (status === 'listening') {
                ui.statusBadge.className = 'listening';
                ui.statusText.textContent = 'üü¢ –°–ª—É—à–∞–µ—Ç –≤–∞—Å';
            } else {
                ui.statusText.textContent = status;
            }
            // ‚≠ê –í–°–ï–ì–î–ê –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–´–ô –ß–ê–¢!
            ui.chatInput.disabled = false;
            ui.sendMessageBtn.disabled = false;
        }

        // ‚≠ê –î–û–ë–ê–í–ò–¢–¨ –í –ò–°–¢–û–†–ò–Æ
        function addTranscript(message, sender) {
            const time = new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            state.transcripts.push({ message, sender, time });
            
            const div = document.createElement('div');
            div.className = `transcript-msg ${sender}`;
            div.innerHTML = `<strong>${sender === 'user' ? 'üë§' : 'ü§ñ'}</strong> ${message}<div class="transcript-time">${time}</div>`;
            ui.transcriptList.appendChild(div);
            ui.transcriptList.scrollTop = ui.transcriptList.scrollHeight;
        }

        // ‚≠ê –û–¢–ü–†–ê–í–ò–¢–¨ –°–û–û–ë–©–ï–ù–ò–ï (–ë–ï–ó –ë–õ–û–ö–ò–†–û–í–ö–ò)
        async function sendMessage() {
            const message = ui.chatInput.value.trim();
            if (!message) return;

            addTranscript(message, 'user');
            ui.chatInput.value = '';

            fetch('/api/send-event', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({
                    session_token: state.sessionToken,
                    event_type: 'user_message',
                    data: { text: message, type: 'text' }
                })
            }).catch(e => console.error('Send error:', e));
        }

        // ‚≠ê –ü–û–ö–ê–ó–ê–¢–¨ –§–ò–ù–ê–õ–¨–ù–£–Æ –ò–°–¢–û–†–ò–Æ
        function showFinalTranscript() {
            ui.finalTranscript.innerHTML = '';
            state.transcripts.forEach(item => {
                const div = document.createElement('div');
                div.className = 'tr-item';
                div.innerHTML = `<strong>${item.sender === 'user' ? 'üë§ –í—ã' : 'ü§ñ –ê–≤–∞—Ç–∞—Ä'} (${item.time}):</strong><br>${item.message}`;
                ui.finalTranscript.appendChild(div);
            });
        }

        // ‚≠ê –°–ö–ê–ß–ê–¢–¨ JSON
        function downloadTranscript() {
            const data = {
                timestamp: new Date().toISOString(),
                duration: state.secondsLeft,
                messages: state.transcripts
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ‚≠ê –ö–û–ü–ò–†–û–í–ê–¢–¨ –¢–ï–ö–°–¢
        function copyTranscript() {
            let text = 'WOW-Agent Dialog Transcript\n';
            text += '=' .repeat(40) + '\n\n';
            state.transcripts.forEach(item => {
                text += `[${item.time}] ${item.sender === 'user' ? 'USER' : 'AVATAR'}: ${item.message}\n`;
            });
            text += '\n' + '='.repeat(40) + '\n';
            text += `Duration: ${state.secondsLeft}s\n`;
            text += `Exported: ${new Date().toLocaleString()}\n`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }).catch(() => {
                alert('‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
            });
        }

        async function postJSON(url, body) {
            const r = await fetch(url, {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify(body || {})
            });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const text = await r.text();
            return text ? JSON.parse(text) : {};
        }

        function startTimer() {
            clearInterval(state.countdown);
            state.secondsLeft = 0;
            state.countdown = setInterval(() => {
                state.secondsLeft++;
                const mins = Math.floor(state.secondsLeft / 60);
                const secs = state.secondsLeft % 60;
                ui.timer.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
            }, 1000);
        }

        async function connectLiveKit(payload) {
            if (!window.LivekitClient) throw new Error("LiveKit –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");

            const lkUrl = payload?.livekit_url;
            const lkToken = payload?.livekit_client_token;
            if (!lkUrl || !lkToken) throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

            const { Room, RoomEvent } = window.LivekitClient;
            if (state.room) await state.room.disconnect();

            state.room = new Room({
                adaptiveStream: true,
                dynacast: true,
                autoSubscribe: true,
            });

            state.room.on(RoomEvent.TrackSubscribed, (track) => {
                if (track.kind === "video") {
                    ui.videoContainer.innerHTML = '';
                    const el = track.attach();
                    state.videoEl = el;
                    ui.videoContainer.appendChild(el);
                }
                if (track.kind === "audio") {
                    const el = track.attach();
                    document.body.appendChild(el);
                    el.play().catch(() => {});
                }
            });

            state.room.on(RoomEvent.DataReceived, (payload) => {
                try {
                    const data = new TextDecoder().decode(payload);
                    const event = JSON.parse(data);

                    if (event.type === 'avatar_start_talking') {
                        updateStatus('speaking');
                        if (state.localMicTrack) state.localMicTrack.mute();
                    }

                    if (event.type === 'avatar_stop_talking') {
                        updateStatus('listening');
                        if (state.localMicTrack) state.localMicTrack.unmute();
                    }

                    if (event.type === 'avatar_message' && event.data?.text) {
                        addTranscript(event.data.text, 'avatar');
                    }
                } catch (e) {
                    console.error("Data error:", e);
                }
            });

            state.room.on(RoomEvent.Disconnected, stopSession);

            await state.room.connect(lkUrl, lkToken);
            await state.room.startAudio();
        }

        async function startSession() {
            try {
                ui.startBtn.disabled = true;
                showScreen('loading');

                const tokenData = await postJSON("/api/token", { language: "ru" });
                state.sessionId = tokenData.session_id;
                state.sessionToken = tokenData.session_token;

                const startData = await postJSON("/api/start", { session_token: state.sessionToken });
                const payload = startData?.data ?? startData;

                await connectLiveKit(payload);

                try {
                    state.localMicTrack = await window.LivekitClient.createLocalAudioTrack({
                        echoCancellation: true,
                        noiseSuppression: true
                    });
                    await state.room.localParticipant.publishTrack(state.localMicTrack);
                } catch (e) {
                    alert("–í–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!");
                }

                showScreen('chat');
                startTimer();
                updateStatus('listening');
                state.transcripts = [];
                ui.transcriptList.innerHTML = '';

            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
                showScreen('welcome');
                ui.startBtn.disabled = false;
            }
        }

        async function stopSession() {
            clearInterval(state.countdown);

            if (state.localMicTrack) {
                state.localMicTrack.stop();
                state.localMicTrack = null;
            }
            if (state.room) {
                state.room.disconnect();
                state.room = null;
            }
            if (state.videoEl) state.videoEl.remove();

            if (state.sessionId && state.sessionToken) {
                try {
                    await postJSON("/api/stop", { 
                        session_id: state.sessionId, 
                        session_token: state.sessionToken 
                    });
                } catch(e) {}
            }

            // –°–û–•–†–ê–ù–ò–¢–¨ –í localStorage
            localStorage.setItem('last_transcript', JSON.stringify(state.transcripts));
            console.log("üìù –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è:", state.transcripts);

            // –ü–û–ö–ê–ó–ê–¢–¨ –§–ò–ù–ê–õ–¨–ù–´–ô –≠–ö–†–ê–ù
            showFinalTranscript();
            showScreen('thankYou');
            ui.startBtn.disabled = false;
        }

        ui.startBtn.addEventListener('click', startSession);
        ui.closeBtn.addEventListener('click', stopSession);
        ui.sendMessageBtn.addEventListener('click', sendMessage);
        ui.chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        ui.downloadBtn.addEventListener('click', downloadTranscript);
        ui.copyBtn.addEventListener('click', copyTranscript);
        ui.reloadBtn.addEventListener('click', () => location.reload());
        ui.leadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
        });

        console.log("‚ú® WOW Widget Ready");
    </script>
</body>
</html>
